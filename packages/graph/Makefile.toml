extend = { path = "../../.github/scripts/rust/Makefile.toml" }

[tasks.touch-environment]
private = true
command = "touch"
args = ["${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/../../.env.local"]

[tasks.yarn-install-migrations]
description = "Installs the required yarn dependencies for the migrations"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/migrations"

[tasks.recreate-db]
run_task = { name = ["recreate-db-task", "migrate-up"] }

[tasks.recreate-db-task]
private = true
description = "Recreates the database"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/migrations"
args = ["graph:recreate-db"]

[tasks.migrate-up]
category = "Deploy"
description = "Runs all migrations"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/migrations"
env_files = ["../.env"]
args = ["graph:migrate", "up"]

[tasks.deployment-up]
category = "Deploy"
description = "Spins up the deployment environment"
extend = "docker"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/deployment"
args = ["compose", "--env-file", "../.env", "up", "--wait"]

[tasks.deployment-down]
category = "Deploy"
description = "Tears down the deployment environment"
extend = "docker"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/deployment"
args = ["compose", "--env-file", "../.env", "down"]

[tasks.build-docker]
category = "Deploy"
description = "Spins up the Graph API as external service"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/../../"
env = { DOCKER_BUILDKIT = 1 }
args = ["external-services", "build", "graph", "${@}"]
dependencies = ["touch-environment"]

[tasks.graph-up]
category = "Deploy"
description = "Spins up the Graph API as external service"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/../../"
args = ["external-services", "up", "--wait", "graph", "${@}"]
dependencies = ["touch-environment"]

[tasks.graph-down]
category = "Deploy"
description = "Tears down up the Graph API"
extend = "yarn"
cwd = "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/../../"
args = ["external-services", "down", "${@}"]

[tasks.test-docker]
run_task = { name = ["yarn-install-migrations", "graph-up", "test-rest-api", "graph-down"] }

[tasks.test-rest-api]
# This is a temporary solution until we have e2e tests in place
extend = "yarn"
args = ["httpyac", "send", "--all", "${CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY}/hash_graph/tests/rest-test.http", "${@}"]
