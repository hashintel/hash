name: AI PR Review

on:
  pull_request:
    types: [review_requested]

jobs:
  check-conditions:
    runs-on: ubuntu-24.04
    outputs:
      should_review: ${{ steps.set-output.outputs.should_review }}
    steps:
      - name: Check if review is requested for hashdotai
        id: check-reviewer
        run: |
          echo "Requested reviewer: ${{ github.event.requested_reviewer.login }}"
          if [[ "${{ github.event.requested_reviewer.login }}" == "hashdotai" ]]; then
            echo "✅ Review requested for hashdotai"
            echo "is_hashdotai=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Review not requested for hashdotai"
            echo "is_hashdotai=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR author
        id: check-maintainer
        if: steps.check-reviewer.outputs.is_hashdotai == 'true'
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"
          
          echo "Checking if $PR_AUTHOR is a maintainer on $REPO"
          
          # Get the permission level of the PR author
          PERMISSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$REPO/collaborators/$PR_AUTHOR/permission" | \
            jq -r '.permission')
          
          # Check if the permission level indicates maintainer status (admin or write)
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "✅ $PR_AUTHOR is a maintainer"
            echo "is_maintainer=true" >> $GITHUB_OUTPUT
          else
            echo "❌ $PR_AUTHOR is not a maintainer"
            echo "is_maintainer=false" >> $GITHUB_OUTPUT
          fi

      - name: Set final output
        id: set-output
        run: |
          if [[ "${{ steps.check-reviewer.outputs.is_hashdotai }}" == "true" && "${{ steps.check-maintainer.outputs.is_maintainer }}" == "true" ]]; then
            echo "✅ All conditions met - will run AI review"
            echo "should_review=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Conditions not met - will skip AI review"
            echo "should_review=false" >> $GITHUB_OUTPUT
          fi

  review:
    needs: check-conditions
    if: needs.check-conditions.outputs.should_review == 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 2
      
      - name: Install Claude Code
        run: npm install -g -y @anthropic-ai/claude-code
      
      - name: Run AI Code PR Review
        run: claude code -p 'please review PR ${{ github.event.pull_request.number }}, following the instructions in CLAUDE.md. Follow each numbered instruction for PR reviews in CLAUDE.md exactly.'
        env:
          GH_TOKEN: ${{ secrets.MACHINE_USER_TOKEN }}