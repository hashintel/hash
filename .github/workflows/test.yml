name: Test

on:
  pull_request:
  push:
    branches:
      - main
  merge_group:

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: hashintel
  TURBO_REMOTE_ONLY: true

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      units: ${{ steps.packages.outputs.units }}
      integrations: ${{ steps.packages.outputs.integrations }}
      build-graph: ${{ steps.packages.outputs.build-graph }}
      build-ai-worker-ts: ${{ steps.packages.outputs.build-ai-worker-ts }}
      build-ai-worker-py: ${{ steps.packages.outputs.build-ai-worker-py }}
      build-integration-worker: ${{ steps.packages.outputs.build-integration-worker }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          fetch-depth: 2

      - name: Install turbo
        run: yarn global add turbo

      - name: Determine changed packages
        id: packages
        run: |
          UNIT_PACKAGES=$(turbo run test \
              --filter '!@tests/*...[HEAD^]' \
              --dry-run=json \
            | jq '.tasks[] | select(.task == "test" and .command != "<NONEXISTENT>") | {package: .package}' \
            | jq -c --slurp '{ include: . }')

          INTEGRATION_PACKAGES=$(turbo run test \
              --filter '@tests/*...[HEAD^]' \
              --dry-run=json \
            | jq '.tasks[] | select(.task == "test" and .command != "<NONEXISTENT>") | {package: .package}' \
            | jq -c --slurp '{ include: . }')

          REQUIRES_GRAPH=$(turbo run build --filter '@apps/hash-graph...[HEAD^]' --dry-run=json | jq '.packages != []')
          REQUIRES_AI_WORKER_TS=$(turbo run build --filter '@apps/hash-ai-worker-ts...[HEAD^]' --dry-run=json | jq '.packages != []')
          REQUIRES_AI_WORKER_PY=$(turbo run build --filter '@apps/hash-ai-worker-py...[HEAD^]' --dry-run=json | jq '.packages != []')
          REQUIRES_INTEGRATION_WORKER=$(turbo run build --filter '@apps/hash-integration-worker...[HEAD^]' --dry-run=json | jq '.packages != []')

          if echo "$INTEGRATION_PACKAGES" | grep -q '@tests/hash-backend-integration'; then
              REQUIRES_GRAPH=true
          fi

          if echo "$INTEGRATION_PACKAGES" | grep -q '@tests/hash-playwright'; then
            REQUIRES_GRAPH=true
            REQUIRES_AI_WORKER_TS=true
            REQUIRES_AI_WORKER_PY=true
            REQUIRES_INTEGRATION_WORKER=true
          fi

          set -x
          echo "units=$UNIT_PACKAGES" >> $GITHUB_OUTPUT
          echo "integrations=$INTEGRATION_PACKAGES" >> $GITHUB_OUTPUT
          echo "build-graph=$REQUIRES_GRAPH" >> $GITHUB_OUTPUT
          echo "build-ai-worker-ts=$REQUIRES_AI_WORKER_TS" >> $GITHUB_OUTPUT
          echo "build-ai-worker-py=$REQUIRES_AI_WORKER_PY" >> $GITHUB_OUTPUT
          echo "build-integration-worker=$REQUIRES_INTEGRATION_WORKER" >> $GITHUB_OUTPUT

  unit:
    name: Unit
    needs: [setup]
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.units) }}
      fail-fast: false
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Install turbo
        run: yarn global add turbo

      - name: Prune repository
        run: turbo prune --scope="${{ matrix.package }}"

      - name: Install yarn dependencies
        env:
          SKIP_HUSKY: true
        run: yarn install --cwd out

      - name: Prepare tests
        working-directory: out
        run: turbo run ^test --filter "${{ matrix.package }}"

      - name: Run tests
        working-directory: out
        run: turbo run test --log-order stream --filter "${{ matrix.package }}"

  build-graph:
    name: Build HASH-Graph
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.build-graph == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Build image
        uses: ./.github/actions/build-docker-images
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          hash-graph: true

  build-ai-worker-ts:
    name: Build HASH-AI-Worker-TS
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.build-ai-worker-ts == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Build image
        uses: ./.github/actions/build-docker-images
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          hash-ai-worker-ts: true

  build-ai-worker-py:
    name: Build HASH-AI-Worker-PY
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.build-ai-worker-py == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Build image
        uses: ./.github/actions/build-docker-images
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          hash-ai-worker-py: true

  build-integration-worker:
    name: Build HASH-Integration-Worker
    runs-on: ubuntu-latest
    needs: [setup]
    if: needs.setup.outputs.build-integration-worker == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Build image
        uses: ./.github/actions/build-docker-images
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          hash-integration-worker: true

  integration:
    name: Integrations
    needs:
      [
        setup,
        build-graph,
        build-ai-worker-ts,
        build-ai-worker-py,
        build-integration-worker,
      ]
    strategy:
      matrix: ${{ fromJSON(needs.setup.outputs.integrations) }}
      fail-fast: false
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Install turbo
        run: yarn global add turbo

      - name: Prune repository
        run: |
          turbo prune --scope="${{ matrix.package }}"
          cp .env out/.env

      - name: Install yarn dependencies
        env:
          SKIP_HUSKY: true
        run: yarn install --cwd out

      - name: Load Docker images
        uses: ./.github/actions/load-docker-images
        with:
          hash-graph: true
          hash-ai-worker-ts: ${{ matrix.package == '@tests/hash-playwright' }}
          hash-ai-worker-py: ${{ matrix.package == '@tests/hash-playwright' }}
          hash-integration-worker: ${{ matrix.package == '@tests/hash-playwright' }}

      - name: Launch external services
        run: |
          turbo codegen --filter '@apps/hash-external-services'
          if [[ ${{ matrix.package }} != '@tests/hash-playwright' ]]; then
            yarn workspace @apps/hash-external-services deploy:test up graph kratos --wait
          else 
            yarn workspace @apps/hash-external-services deploy up --detach
          fi

      - name: Launch backend
        if: matrix.package == '@tests/hash-playwright'
        working-directory: out
        run: |
          yarn dev:backend 2>&1 | tee var/logs/backend.log &
          yarn wait-on --timeout 120000 http://0.0.0.0:5001

      - name: Build and launch frontend
        if: matrix.package == '@tests/hash-playwright'
        working-directory: out
        run: |
          yarn workspace @apps/hash-frontend next build
          yarn workspace @apps/hash-frontend start 2>&1 | tee var/logs/frontend.log &
          yarn wait-on --timeout 30000 http://0.0.0.0:3000

      - name: Prepare tests
        working-directory: out
        run: turbo run ^test --filter "${{ matrix.package }}"

      - name: Run tests
        working-directory: out
        run: turbo run test --log-order stream --filter "${{ matrix.package }}"
