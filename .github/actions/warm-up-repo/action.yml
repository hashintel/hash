name: Warm-up repo
description: Prepares Node and Yarn dependencies

inputs:
  playwright-deps:
    default: ""
    description: "List of browsers separated by space, e.g. 'chrome firefox'"
    required: false

runs:
  using: composite

  steps:
    - uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65 # v4.0.0
      with:
        node-version: 18 ## aligned with Node version on Vercel
        # cache: yarn ## Currently disabled because of frequent timeouts

    - name: Install poetry
      run: pipx install poetry
      shell: bash

    - name: Set up Python 3.11
      uses: actions/setup-python@65d7f2d534ac1bc67fcd62888c5f4f3d2cb2b236 # v4.7.1
      with:
        python-version: "^3.11"
        cache: poetry

    - name: yarn install
      uses: nick-fields/retry@14672906e672a08bd6eeb15720e9ed3ce869cdd4 # v2.9.0
      with:
        max_attempts: 3
        timeout_minutes: 10
        shell: bash
        command: |
          export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD="${{ inputs.playwright-deps == '' }}"
          yarn install

    - name: npx playwright install
      if: ${{ inputs.playwright-deps != '' }}
      uses: nick-fields/retry@14672906e672a08bd6eeb15720e9ed3ce869cdd4 # v2.9.0
      with:
        max_attempts: 3
        timeout_minutes: 10
        shell: bash
        command: npx playwright install --with-deps ${{ inputs.playwright-deps }}
