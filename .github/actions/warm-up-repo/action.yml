name: Warm-up repo
description: Prepares Node and Yarn dependencies

inputs:
  playwright-deps:
    default: ""
    description: "List of browsers separated by space, e.g. 'chrome firefox'"
    required: false
  token:
    required: true

runs:
  using: composite

  steps:
    - name: Install Tools
      uses: jdx/mise-action@5083fe46898c414b2475087cc79da59e7da859e8 # v2.1.11
      with:
        install_args: --jobs 1
      env:
        MISE_NODE_COREPACK: 1
        GITHUB_TOKEN: ${{ inputs.token }}

    - name: "Install Rust"
      shell: bash
      run: |
        # extract components from the rust-toolchain.toml
        COMPONENTS="$(yq -p toml '.toolchain.components[]' rust-toolchain.toml)"
        TOOLCHAIN_CHANNEL="$(yq -p toml '.toolchain.channel' rust-toolchain.toml)"
        rustup toolchain install "$TOOLCHAIN_CHANNEL"

        for component in $COMPONENTS; do
          rustup component add --toolchain "$TOOLCHAIN_CHANNEL" "$component"
        done

        echo "RUSTUP_TOOLCHAIN=$TOOLCHAIN_CHANNEL" >> $GITHUB_ENV

    - name: Install WASM tools
      uses: taiki-e/install-action@3c8fc6eaa5fcff049bb133c1f540c6c2287a191f # v2.49.10
      with:
        tool: wasm-pack@0.12.1

    - name: Install yarn dependencies
      uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
      env:
        LEFTHOOK: 0
      with:
        max_attempts: 3
        timeout_minutes: 10
        shell: bash
        # we disable hardened mode (https://yarnpkg.com/features/security), as it significantly slows down the installation
        # immutable installs are still enforced in CI
        command: |
          export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD="${{ inputs.playwright-deps == '' }}"
          export YARN_ENABLE_HARDENED_MODE=0
          yarn install --immutable

    - name: npx playwright install
      if: ${{ inputs.playwright-deps != '' }}
      uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
      with:
        max_attempts: 3
        timeout_minutes: 10
        shell: bash
        command: npx playwright install --with-deps ${{ inputs.playwright-deps }}
