name: Prune repository
description: "Prunes the repository to only the files required for the given scope"
inputs:
  scope:
    description: "Scope to prune to"
    required: true

runs:
  using: "composite"
  steps:
    - name: Install turbo
      shell: bash
      run: yarn global add turbo

    - name: Prune repository
      shell: bash
      run: turbo prune --scope="${{ inputs.scope }}"

    - name: Copy required files
      shell: bash
      run: |
        cp .env out/.env
        cp yarn.lock out/yarn.lock
        cp -r patches out/patches

    - name: Allow patch files to fail
      shell: bash
      run: |
        cat package.json | sed 's/\("postinstall".*patch-package.*\)--error-on-fail=true/\1--error-on-fail=false/g' > out/package.json

    - name: Remove old repository files
      shell: bash
      run: |
        git ls-files -z | xargs -0 rm -f
        git ls-tree --name-only -d -r -z HEAD | sort -rz | xargs -0 rm -rf

    - name: Restore `out` directory
      shell: bash
      run: |
        shopt -s dotglob
        mv out/* .
        rmdir out

        cat package.json
