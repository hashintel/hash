name: Setup Rust CI
description: Prepares Rust CI and cache dependencies

inputs:
  toolchain:
    description: "Rust toolchain to install"
    required: true
  key:
    description: "Key used to cache dependencies"
    required: true
outputs:
  cache-hit:
    description: "A boolean value to indicate an exact match was found for the key"
    value: ${{ steps.rust-cache.outputs.cache-hit }}
runs:
  using: composite
  steps:
    - name: Install Rust
      id: toolchain
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ inputs.toolchain }}
        override: true

    - name: Cache Node dependencies
      uses: actions/cache@v3
      with:
        path: |
          **/node_modules
        key: ${{ hashFiles('**/yarn.lock') }}

    - name: Cache Rust dependencies
      id: rust-cache
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/.crates.toml
          ~/.cargo/.crates2.json
          ~/.cargo/bin
          ~/.cargo/registry/index
          ~/.cargo/registry/cache
          ~/.cargo/git/checkouts
          **/target/
        key: ${{ inputs.toolchain }}-${{ inputs.key }}-${{ hashFiles('**/Cargo.lock') }}-Test-2
        restore-keys: ${{ inputs.toolchain }}-${{ inputs.key }}-

    - name: Install cargo-make
      shell: bash
      run: cargo install cargo-make
