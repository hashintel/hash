name: Install sccache
description: Setup sccache for Rust project caching
inputs:
  vault_address:
    description: The URL of the Vault server
    required: true

runs:
  using: composite
  steps:
    - name: Retrieve secrets
      id: secrets
      uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
      with:
        exportToken: true
        url: ${{ inputs.vault_address }}
        method: jwt
        role: dev
        secrets: |
          infrastructure/data/github/actions/secrets sccache_r2_account_id | SCCACHE_ACCOUNT_ID ;
          infrastructure/data/github/actions/secrets sccache_r2_bucket | SCCACHE_BUCKET ;
          infrastructure/data/github/actions/secrets sccache_r2_key_id | SCCACHE_AWS_ACCESS_KEY_ID ;
          infrastructure/data/github/actions/secrets sccache_r2_access_key | SCCACHE_AWS_SECRET_ACCESS_KEY ;

    - name: Setup sccache
      uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

    - name: Start sscache server
      env:
        SCCACHE_BUCKET: ${{ env.SCCACHE_BUCKET }}
        SCCACHE_ENDPOINT: https://${{ env.SCCACHE_ACCOUNT_ID }}.r2.cloudflarestorage.com
        SCCACHE_REGION: auto
        SCCACHE_LOG: debug
        SCCACHE_ERROR_LOG: /tmp/sccache.log
        SCCACHE_S3_USE_SSL: "true"
        SCCACHE_S3_KEY_PREFIX: hashintel/hash/
        AWS_ACCESS_KEY_ID: ${{ env.SCCACHE_AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ env.SCCACHE_AWS_SECRET_ACCESS_KEY }}
        AWS_EC2_METADATA_DISABLED: "true"
      shell: bash
      run: |
        sccache --start-server

    - name: Inject sccache variables into environment
      shell: bash
      run: |

        echo "RUSTC_WRAPPER=${SCCACHE_PATH}" >> $GITHUB_ENV
