name: Clean up disk
description: "Cleans up disk space by removing unnecessary files"

runs:
  using: "composite"
  steps:
    - name: Check disk space
      shell: bash
      run: |
        echo "Overal disk space usage before cleanup:"
        df -h
        echo

        # Install ncdu if available (fast disk usage analyzer)
        if command -v apt-get &> /dev/null; then
          sudo apt-get update -qq && sudo apt-get install -y -qq ncdu 2>/dev/null || true
        fi

        if command -v ncdu &> /dev/null; then
          echo "Using ncdu for fast disk analysis:"
          # ncdu export mode - much faster than du
          sudo ncdu -x -o- --exclude /proc --exclude /sys --exclude /dev / 2>/dev/null | \
            grep -E '"asize":[0-9]{10,}' | head -n 30 || true
        else
          echo "Finding largest directories (depth=3, parallel scan):"
          # Fallback to parallel du
          {
            du -h --max-depth=3 /usr 2>/dev/null &
            du -h --max-depth=3 /opt 2>/dev/null &
            du -h --max-depth=3 /var 2>/dev/null &
            wait
          } | awk '$1 ~ /[0-9.]+G|[5-9][0-9][0-9]M/' | head -n 40 || true
        fi
        echo

    - name: Remove unused files
      shell: bash
      run: |
        echo "Removing unused files in parallel..."

        # Delete large directories in parallel background jobs
        sudo rm -rf /usr/share/dotnet &
        sudo rm -rf /usr/share/swift &
        sudo rm -rf /usr/lib/jvm &
        sudo rm -rf /usr/local/.ghcup &
        sudo rm -rf /usr/local/lib/android &
        sudo rm -rf /usr/local/share/powershell &
        sudo rm -rf /opt/ghc &

        # Wait for all deletions to complete
        wait
        echo "Deletion complete"
        echo

    - name: Remove unused packages
      shell: bash
      run: |
        echo "Removing unused packages..."
        sudo apt-get autoremove -y
        sudo apt-get autoclean -y
        echo


    - name: Check disk space
      shell: bash
      run: |
        echo "Overal disk space usage after cleanup:"
        df -h
