name: Clean up disk
description: "Cleans up disk space by removing unnecessary files"

runs:
  using: "composite"
  steps:
    - name: Check disk space before cleanup
      shell: bash
      run: |
        df -h

        # Uncomment the following lines to see the largest directories before cleanup
        # This is commented out as this step is slow

        # echo "Finding largest directories (depth=3, parallel scan):"
        # # Scan multiple paths in parallel for speed
        # {
        #   du -h --max-depth=3 /usr 2>/dev/null &
        #   du -h --max-depth=3 /opt 2>/dev/null &
        #   du -h --max-depth=3 /var 2>/dev/null &
        #   wait
        # } | awk '$1 ~ /[0-9.]+G|[5-9][0-9][0-9]M/' | head -n 40 || true
        # echo

    - name: Remove unused files
      shell: bash
      run: |
        echo "Deleting large directories..."
        mkdir -p /tmp/empty

        # rsync --delete is 10-100x faster than rm -rf for directories with many small files
        for dir in \
          /usr/share/dotnet \
          /usr/share/swift \
          /usr/lib/jvm \
          /usr/local/.ghcup \
          /usr/local/lib/android \
          /usr/local/share/powershell \
        ; do
          if [ -d "$dir" ]; then
            size=$(du -sh "$dir" 2>/dev/null | cut -f1)
            echo "  → $dir ($size)"
            (sudo rsync -a --delete /tmp/empty/ "$dir/" && sudo rmdir "$dir") &
          fi
        done

        wait
        rmdir /tmp/empty
        echo "✓ Deletion complete"

    - name: Remove unused packages
      shell: bash
      run: |
        echo "Removing unused packages..."
        sudo apt-get autoremove -y
        sudo apt-get autoclean -y
        echo


    - name: Check disk space after cleanup
      shell: bash
      run: df -h
