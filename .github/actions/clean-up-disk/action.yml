name: Clean up disk
description: "Cleans up disk space by removing unnecessary files"

runs:
  using: "composite"
  steps:
    - name: Check disk space
      shell: bash
      run: |
        echo "Overal disk space usage before cleanup:"
        df -h
        echo

        echo "Top directories in /usr before cleanup:"
        du -h --max-depth=1 /usr 2>/dev/null || true
        echo

        echo "Top directories in /usr/lib before cleanup:"
        du -h --max-depth=1 /usr/lib 2>/dev/null | head -n 50 || true
        echo

        echo "Top directories in /usr/local before cleanup:"
        du -h --max-depth=2 /usr/local 2>/dev/null | head -n 50 || true
        echo

        echo "Top directories in /usr/share before cleanup:"
        du -h --max-depth=1 /usr/share 2>/dev/null | head -n 50 || true
        echo

        echo "Top directories in /var before cleanup:"
        du -h --max-depth=1 /var 2>/dev/null | head -n 50 || true
        echo

        echo "Top directories in /opt before cleanup:"
        du -h --max-depth=1 /opt 2>/dev/null || true
        echo

    - name: Remove unused files
      shell: bash
      run: |
        echo "Removing unused files in parallel..."

        # Delete large directories in parallel background jobs
        sudo rm -rf /usr/share/dotnet &
        sudo rm -rf /usr/share/swift &
        sudo rm -rf /usr/lib/jvm &
        sudo rm -rf /usr/local/.ghcup &
        sudo rm -rf /usr/local/lib/android &
        sudo rm -rf /usr/local/share/powershell &
        sudo rm -rf /opt/ghc &

        # Wait for all deletions to complete
        wait
        echo "Deletion complete"
        echo

    - name: Remove unused packages
      shell: bash
      run: |
        echo "Removing unused packages..."
        sudo apt-get autoremove -y
        sudo apt-get autoclean -y
        echo


    - name: Check disk space
      shell: bash
      run: |
        echo "Overal disk space usage after cleanup:"
        df -h
